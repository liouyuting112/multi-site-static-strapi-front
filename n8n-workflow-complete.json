{
  "name": "AI è‡ªå‹•ç”Ÿæˆæ–‡ç« å®Œæ•´æµç¨‹ï¼ˆN8N åŸç”Ÿï¼‰",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "generate-articles",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300],
      "webhookId": "generate-articles"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "SITES",
              "value": "={{ $json.body.sites ? ($json.body.sites.join ? $json.body.sites.join(',') : $json.body.sites) : 'all' }}"
            },
            {
              "name": "DATE",
              "value": "={{ $json.body.date || $now.format('YYYY-MM-DD') }}"
            },
            {
              "name": "COUNT",
              "value": "={{ $json.body.count || '1' }}"
            },
            {
              "name": "CATEGORY",
              "value": "={{ $json.body.category || 'daily' }}"
            },
            {
              "name": "STRAPI_URL",
              "value": "https://multi-site-strapi-backend-production.up.railway.app"
            },
            {
              "name": "STRAPI_TOKEN",
              "value": "55f0580acab131abb8b2ddf799949b620a5ce912870030d61a46732f92e794512eda3634fe07397be92e6bc5399a444534269c0affd7b3eabd3a80136146406bf012eb491b17dcf8587af650e9b0a68f75d63cd733b748352df1da591f5c811c4e29ded4b64d9c016ab8f91dd623fc5c813b7705162b87fa29443d3a5e6b1993"
            },
            {
              "name": "GEMINI_API_KEY",
              "value": "AIzaSyDuL2vhVx2XfjJrlZcunx2IA_L94eKptTI"
            },
            {
              "name": "OPENAI_API_KEY",
              "value": "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"
            },
            {
              "name": "PROMPT_FILE_PATH",
              "value": "C:\\Users\\yyutingliu\\Downloads\\AIç”Ÿæˆç¶²ç«™æ¸¬è©¦\\cursor\\ä¸€å€‹ä¸»é¡Œå¤šå€‹ç«™(è½åœ°)\\ä¸‹è¼‰\\æ–°å¢æ–‡ç« æè©.txt"
            },
            {
              "name": "GITHUB_REPO_PATH",
              "value": "C:\\Users\\yyutingliu\\Downloads\\AIç”Ÿæˆç¶²ç«™æ¸¬è©¦\\cursor\\ä¸€å€‹ä¸»é¡Œå¤šå€‹ç«™(è½åœ°)"
            },
            {
              "name": "GITHUB_REPO_URL",
              "value": "https://github.com/liouyuting112/multi-site-static-strapi-front.git"
            }
          ]
        },
        "options": {}
      },
      "id": "set-variables",
      "name": "Set Variables",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [450, 300]
    },
    {
      "parameters": {
        "jsCode": "// è™•ç†æ•¸é‡ï¼ˆå¦‚æœæ˜¯ç¯„åœï¼Œéš¨æ©Ÿé¸æ“‡ï¼‰\nconst inputData = $input.item.json || {};\nconst count = inputData.COUNT || '1';\nlet finalCount = count;\nif (typeof count === 'string' && count.includes('-')) {\n  const [min, max] = count.split('-').map(Number);\n  finalCount = Math.floor(Math.random() * (max - min + 1)) + min;\n} else {\n  finalCount = parseInt(count, 10) || 1;\n}\n\n// è™•ç†ç«™é»åˆ—è¡¨\nconst sitesStr = inputData.SITES || 'all';\nlet sites = [];\nif (sitesStr === 'all') {\n  // ç¨å¾Œå¾ Strapi å–å¾—\n  sites = ['all'];\n} else if (typeof sitesStr === 'string') {\n  sites = sitesStr.split(',').map(s => s.trim()).filter(s => s);\n} else if (Array.isArray(sitesStr)) {\n  sites = sitesStr.map(s => String(s).trim()).filter(s => s);\n} else {\n  sites = ['all'];\n}\n\n// ç¢ºä¿æ‰€æœ‰å¿…è¦çš„è®Šæ•¸éƒ½è¢«å‚³éï¼ˆåŒ…æ‹¬ STRAPI_URL, STRAPI_TOKEN ç­‰ï¼‰\nreturn {\n  json: {\n    // ä¿ç•™æ‰€æœ‰åŸå§‹è³‡æ–™\n    ...inputData,\n    // æ›´æ–°è™•ç†å¾Œçš„è³‡æ–™\n    COUNT: finalCount,\n    SITES_ARRAY: sites,\n    SITES_TO_PROCESS: sitesStr,\n    // ç¢ºä¿é€™äº›è®Šæ•¸å­˜åœ¨ï¼ˆå¦‚æœæ²’æœ‰ï¼Œä½¿ç”¨é è¨­å€¼ï¼‰\n    STRAPI_URL: inputData.STRAPI_URL || 'https://multi-site-strapi-backend-production.up.railway.app',\n    STRAPI_TOKEN: inputData.STRAPI_TOKEN || '',\n    GEMINI_API_KEY: inputData.GEMINI_API_KEY || '',\n    OPENAI_API_KEY: inputData.OPENAI_API_KEY || '',\n    DATE: inputData.DATE || new Date().toISOString().split('T')[0],\n    CATEGORY: inputData.CATEGORY || 'daily',\n    PROMPT_FILE_PATH: inputData.PROMPT_FILE_PATH || '',\n    GITHUB_REPO_PATH: inputData.GITHUB_REPO_PATH || '',\n    GITHUB_REPO_URL: inputData.GITHUB_REPO_URL || ''\n  }\n};"
      },
      "id": "process-params",
      "name": "Process Parameters",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-all",
              "leftValue": "={{ $json.SITES_ARRAY[0] }}",
              "rightValue": "all",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-sites",
      "name": "Check Sites",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "jsCode": "// æº–å‚™ URL å’Œ Tokenï¼Œç„¶å¾Œå‚³éçµ¦ä¸‹ä¸€å€‹ HTTP Request ç¯€é»\nconst strapiUrl = $json.STRAPI_URL || 'https://multi-site-strapi-backend-production.up.railway.app';\nconst strapiToken = $json.STRAPI_TOKEN || '55f0580acab131abb8b2ddf799949b620a5ce912870030d61a46732f92e794512eda3634fe07397be92e6bc5399a444534269c0affd7b3eabd3a80136146406bf012eb491b17dcf8587af650e9b0a68f75d63cd733b748352df1da591f5c811c4e29ded4b64d9c016ab8f91dd623fc5c813b7705162b87fa29443d3a5e6b1993';\n\nconst url = `${strapiUrl}/api/posts?pagination[pageSize]=1000&fields[0]=site&sort=createdAt:desc`;\n\nconsole.log('ğŸ”— æº–å‚™é€£æ¥:', url);\nconsole.log('ğŸ”‘ Token å‰ 10 å­—å…ƒ:', strapiToken.substring(0, 10));\n\n// å°‡ URL å’Œ Token å‚³éçµ¦ä¸‹ä¸€å€‹ç¯€é»\nreturn {\n  json: {\n    ...$json,\n    FETCH_URL: url,\n    FETCH_AUTH_HEADER: `Bearer ${strapiToken}`\n  }\n};"
      },
      "id": "prepare-fetch-all-sites",
      "name": "Prepare Fetch All Sites",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.FETCH_URL }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $json.FETCH_AUTH_HEADER }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-all-sites",
      "name": "Fetch All Sites",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "jsCode": "// å¾ Strapi å›æ‡‰ä¸­æå–æ‰€æœ‰å”¯ä¸€çš„ç«™é»\nconst data = $input.item.json;\nconst posts = data.data || [];\nconst sites = new Set();\n\nposts.forEach(post => {\n  const attrs = post.attributes || post;\n  if (attrs.site) {\n    sites.add(attrs.site);\n  }\n});\n\nconst sitesArray = Array.from(sites).sort();\n\n// å¾ Process Parameters ç¯€é»å–å¾—æ‰€æœ‰è®Šæ•¸\nconst processParams = $('Process Parameters').first().json || {};\n\nreturn {\n  json: {\n    // ä¿ç•™æ‰€æœ‰åŸå§‹è®Šæ•¸\n    ...processParams,\n    // æ›´æ–°ç«™é»é™£åˆ—\n    SITES_ARRAY: sitesArray,\n    // ç¢ºä¿é€™äº›è®Šæ•¸å­˜åœ¨\n    STRAPI_URL: processParams.STRAPI_URL || 'https://multi-site-strapi-backend-production.up.railway.app',\n    STRAPI_TOKEN: processParams.STRAPI_TOKEN || '',\n    GEMINI_API_KEY: processParams.GEMINI_API_KEY || '',\n    OPENAI_API_KEY: processParams.OPENAI_API_KEY || '',\n    DATE: processParams.DATE || new Date().toISOString().split('T')[0],\n    CATEGORY: processParams.CATEGORY || 'daily',\n    COUNT: processParams.COUNT || 1,\n    PROMPT_FILE_PATH: processParams.PROMPT_FILE_PATH || '',\n    GITHUB_REPO_PATH: processParams.GITHUB_REPO_PATH || '',\n    GITHUB_REPO_URL: processParams.GITHUB_REPO_URL || ''\n  }\n};"
      },
      "id": "extract-sites",
      "name": "Extract Sites",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "jsCode": "// ç‚ºæ¯å€‹ç«™é»å»ºç«‹å¤šå€‹é …ç›®ï¼ˆæ ¹æ“š COUNTï¼‰\nconst sites = $json.SITES_ARRAY || [];\nconst count = $json.COUNT || 1;\nconst items = [];\n\nfor (const site of sites) {\n  for (let i = 0; i < count; i++) {\n    items.push({\n      json: {\n        ...$json,\n        CURRENT_SITE: site,\n        ARTICLE_INDEX: i + 1,\n        ARTICLE_TOTAL: count\n      }\n    });\n  }\n}\n\nreturn items;"
      },
      "id": "split-sites",
      "name": "Split Sites",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.STRAPI_URL || 'https://multi-site-strapi-backend-production.up.railway.app' }}/api/posts?filters[site][$eq]={{ $json.CURRENT_SITE }}&filters[category][$eq]={{ $json.CATEGORY }}&sort=date:desc&pagination[limit]=5",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.STRAPI_TOKEN || '55f0580acab131abb8b2ddf799949b620a5ce912870030d61a46732f92e794512eda3634fe07397be92e6bc5399a444534269c0affd7b3eabd3a80136146406bf012eb491b17dcf8587af650e9b0a68f75d63cd733b748352df1da591f5c811c4e29ded4b64d9c016ab8f91dd623fc5c813b7705162b87fa29443d3a5e6b1993' }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-existing-posts",
      "name": "Fetch Existing Posts",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 300]
    },
    {
      "parameters": {
        "jsCode": "// ä½¿ç”¨é è¨­æç¤ºè©ï¼ˆN8N Code ç¯€é»ä¸å…è¨±ä½¿ç”¨ fs æ¨¡çµ„ï¼‰\nconst prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å…§å®¹å¯«æ‰‹ï¼Œå°ˆé–€ç‚ºç¶²ç«™æ’°å¯«æ–‡ç« ã€‚\n\nè«‹æ ¹æ“šä»¥ä¸‹ç¾æœ‰æ–‡ç« çš„ä¸»é¡Œå’Œé¢¨æ ¼ï¼Œç”Ÿæˆä¸€ç¯‡æ–°çš„æ–‡ç« ï¼š\n\nè¦æ±‚ï¼š\n1. æ¨™é¡Œè¦å¸å¼•äººï¼Œç¬¦åˆç¶²ç«™ä¸»é¡Œ\n2. å…§å®¹ç´„ 800-1200 å­—\n3. ä½¿ç”¨ HTML æ ¼å¼ï¼ˆæ®µè½ç”¨ <p>ï¼Œæ¨™é¡Œç”¨ <h2>ï¼Œåˆ—è¡¨ç”¨ <ul><li>ï¼‰\n4. é¢¨æ ¼è¦è¼•é¬†æœ‰è¶£ï¼Œä½†è¦æœ‰å°ˆæ¥­æ„Ÿ\n\nè«‹ç›´æ¥è¼¸å‡ºå®Œæ•´çš„ HTML æ–‡ç« å…§å®¹ï¼ŒåŒ…å«æ¨™é¡Œå’Œå…§æ–‡ã€‚`;\n\n// æå–ç¾æœ‰æ–‡ç« æ¨™é¡Œ\nconst postsData = $input.item.json;\nconst posts = postsData.data || [];\nconst existingTitles = posts.map(post => {\n  const attrs = post.attributes || post;\n  return `- ${attrs.title || 'ç„¡æ¨™é¡Œ'} (${attrs.date || attrs.publishedAt || ''})`;\n}).join('\\n');\n\nconst fullPrompt = `${prompt}\n\nç«™é»ï¼š${$json.CURRENT_SITE}\nç¾æœ‰æ–‡ç« ç¯„ä¾‹ï¼š\n${existingTitles || '(ç„¡ç¾æœ‰æ–‡ç« )'}\n\nè«‹ç”Ÿæˆä¸€ç¯‡å…¨æ–°çš„æ–‡ç« ï¼Œæ¨™é¡Œå’Œå…§å®¹éƒ½è¦èˆ‡ä¸Šè¿°æ–‡ç« ä¸åŒï¼Œä½†é¢¨æ ¼è¦ä¸€è‡´ã€‚`;\n\nreturn {\n  json: {\n    ...$json,\n    PROMPT: fullPrompt\n  }\n};"
      },
      "id": "prepare-prompt",
      "name": "Prepare Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${$json.GEMINI_API_KEY || 'AIzaSyDuL2vhVx2XfjJrlZcunx2IA_L94eKptTI'}` }}",
        "sendBody": true,
        "bodyContentType": "json",
        "specifyBody": "json",
        "jsonBody": "={{ { \"contents\": [{ \"parts\": [{ \"text\": $json.PROMPT }] }], \"generationConfig\": { \"temperature\": 0.7, \"maxOutputTokens\": 2000 } } }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "id": "call-gemini",
      "name": "Call Gemini API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2050, 300]
    },
    {
      "parameters": {
        "jsCode": "// è§£æ Gemini å›æ‡‰\nconst response = $input.item.json;\nlet aiText = '';\n\ntry {\n  if (response.candidates && response.candidates[0] && response.candidates[0].content && response.candidates[0].content.parts && response.candidates[0].content.parts[0]) {\n    aiText = response.candidates[0].content.parts[0].text || '';\n  } else {\n    aiText = JSON.stringify(response);\n  }\n} catch (e) {\n  aiText = JSON.stringify(response);\n}\n\n// å¾å‰é¢çš„ç¯€é»ç²å–æ‰€æœ‰å¿…è¦çš„è®Šæ•¸\nconst preparePromptNode = $('Prepare Prompt').first();\nconst previousData = preparePromptNode ? preparePromptNode.json : {};\n\n// è§£ææ–‡ç« ï¼ˆæå–æ¨™é¡Œã€å…§å®¹ã€æ‘˜è¦ã€åœ–ç‰‡ï¼‰\nlet cleanedText = aiText.replace(/^```html\\s*/i, '').replace(/\\s*```$/i, '').trim();\n\nlet title = '';\nlet htmlContent = cleanedText;\n\n// æ‰¾ <h1> æˆ– <h2>\nconst h1Match = cleanedText.match(/<h1[^>]*>([^<]+)<\\/h1>/i);\nif (h1Match) {\n  title = h1Match[1].trim();\n  htmlContent = cleanedText.replace(/<h1[^>]*>[\\s\\S]*?<\\/h1>/i, '').trim();\n} else {\n  const h2Match = cleanedText.match(/<h2[^>]*>([^<]+)<\\/h2>/i);\n  if (h2Match) {\n    title = h2Match[1].trim();\n    htmlContent = cleanedText.replace(/<h2[^>]*>[\\s\\S]*?<\\/h2>/i, '').trim();\n  }\n}\n\nif (!title) {\n  const lines = cleanedText.split('\\n').filter(l => l.trim() && !l.trim().startsWith('<'));\n  if (lines.length > 0) {\n    title = lines[0].replace(/^#+\\s*/, '').trim();\n  }\n}\n\nif (!title) {\n  title = 'AI ç”Ÿæˆçš„æ–‡ç« ';\n}\n\n// ç¢ºä¿ HTML å…§å®¹æœ‰åŸºæœ¬çµæ§‹\nif (!htmlContent.includes('<p>') && !htmlContent.includes('<h2>')) {\n  htmlContent = htmlContent\n    .split('\\n\\n')\n    .filter(p => p.trim())\n    .map(p => `<p>${p.trim()}</p>`)\n    .join('\\n\\n');\n}\n\n// æå– excerptï¼ˆ28 å­—å…ƒ + \"...\"ï¼‰\nlet excerpt = '';\nconst firstPMatch = htmlContent.match(/<p[^>]*>([^<]+)<\\/p>/i);\nif (firstPMatch) {\n  let rawExcerpt = firstPMatch[1].trim();\n  if (rawExcerpt.length > 28) {\n    excerpt = rawExcerpt.substring(0, 28) + '...';\n  } else {\n    excerpt = rawExcerpt;\n  }\n} else {\n  const textContent = htmlContent.replace(/<[^>]+>/g, '').trim();\n  if (textContent.length > 0) {\n    if (textContent.length > 28) {\n      excerpt = textContent.substring(0, 28) + '...';\n    } else {\n      excerpt = textContent;\n    }\n  }\n}\n\n// æå– imageUrl\nlet imageUrl = '';\nconst imgMatch = htmlContent.match(/<img[^>]+src=[\"']([^\"']+)[\"']/i);\nif (imgMatch) {\n  imageUrl = imgMatch[1];\n}\n\nreturn {\n  json: {\n    // ä¿ç•™æ‰€æœ‰ä¹‹å‰çš„è®Šæ•¸\n    ...previousData,\n    // æ·»åŠ ç”Ÿæˆçš„æ–‡ç« å…§å®¹\n    GENERATED_TITLE: title,\n    GENERATED_HTML: htmlContent,\n    GENERATED_EXCERPT: excerpt,\n    GENERATED_IMAGE_URL: imageUrl\n  }\n};"
      },
      "id": "parse-article",
      "name": "Parse Article",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2250, 300]
    },
    {
      "parameters": {
        "jsCode": "// æº–å‚™ Strapi payload\n// ç¢ºä¿ DATE å­˜åœ¨ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ä»Šå¤©æ—¥æœŸ\nconst dateStr = $json.DATE || new Date().toISOString().split('T')[0];\nconst timestamp = Date.now().toString().slice(-6);\nconst slug = `${dateStr}-${timestamp}`;\n\n// å¦‚æœæ²’æœ‰ imageUrlï¼Œç”Ÿæˆé è¨­åœ–ç‰‡ URL\nlet finalImageUrl = $json.GENERATED_IMAGE_URL;\nif (!finalImageUrl && dateStr) {\n  const dateSuffix = dateStr.replace(/-/g, '').substring(4);\n  finalImageUrl = `https://raw.githubusercontent.com/test100web/100-website/main/images/${$json.CURRENT_SITE}-daily${dateSuffix}.webp`;\n}\n\n// è™•ç† excerpt\nlet finalExcerpt = $json.GENERATED_EXCERPT || '';\nif (finalExcerpt.endsWith('...')) {\n  finalExcerpt = finalExcerpt.slice(0, -3);\n}\nif (finalExcerpt.length > 28) {\n  finalExcerpt = finalExcerpt.substring(0, 28);\n}\nconst originalLength = ($json.GENERATED_EXCERPT || '').trim().length;\nif (originalLength > 28) {\n  finalExcerpt = finalExcerpt + '...';\n}\n\nconst payload = {\n  data: {\n    site: $json.CURRENT_SITE,\n    category: $json.CATEGORY,\n    slug: slug,\n    title: $json.GENERATED_TITLE,\n    html: $json.GENERATED_HTML,\n    date: dateStr,\n    publishedAt: `${dateStr}T09:00:00.000Z`,\n    isFeatured: true,\n    excerpt: finalExcerpt,\n    imageUrl: finalImageUrl\n  }\n};\n\nreturn {\n  json: {\n    ...$json,\n    STRAPI_PAYLOAD: payload,\n    STRAPI_SLUG: slug\n  }\n};"
      },
      "id": "prepare-strapi-payload",
      "name": "Prepare Strapi Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2450, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.STRAPI_URL || 'https://multi-site-strapi-backend-production.up.railway.app' }}/api/posts",
        "sendBody": true,
        "bodyContentType": "json",
        "specifyBody": "json",
        "jsonBody": "={{ $json.STRAPI_PAYLOAD }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.STRAPI_TOKEN || '55f0580acab131abb8b2ddf799949b620a5ce912870030d61a46732f92e794512eda3634fe07397be92e6bc5399a444534269c0affd7b3eabd3a80136146406bf012eb491b17dcf8587af650e9b0a68f75d63cd733b748352df1da591f5c811c4e29ded4b64d9c016ab8f91dd623fc5c813b7705162b87fa29443d3a5e6b1993' }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "timeout": 30000,
          "retry": {
            "retry": {
              "maxRetries": 3,
              "retryDelay": 1000
            }
          },
          "response": {
            "response": {
              "responseFormat": "json",
              "fullResponse": false
            }
          }
        },
        "continueOnFail": true
      },
      "id": "save-to-strapi",
      "name": "Save to Strapi",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2650, 300]
    },
    {
      "parameters": {
        "jsCode": "// æª¢æŸ¥ Strapi å›æ‡‰ä¸¦æ¨™è¨˜æˆåŠŸæˆ–å¤±æ•—\nconst inputData = $input.item.json || {};\nconst strapiResponse = inputData;\n\n// æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤ï¼ˆN8N HTTP Request ç¯€é»å¤±æ•—æ™‚æœƒæœ‰ error å±¬æ€§ï¼‰\nlet isSuccess = false;\nlet errorMessage = null;\n\n// æª¢æŸ¥æ˜¯å¦æœ‰ N8N éŒ¯èª¤\nif (inputData.error) {\n  isSuccess = false;\n  errorMessage = `HTTP éŒ¯èª¤: ${inputData.error.message || JSON.stringify(inputData.error)}`;\n} else if (inputData.statusCode && inputData.statusCode >= 400) {\n  // HTTP ç‹€æ…‹ç¢¼éŒ¯èª¤\n  isSuccess = false;\n  errorMessage = `HTTP ${inputData.statusCode}: ${inputData.body || inputData.message || 'è«‹æ±‚å¤±æ•—'}`;\n} else if (strapiResponse && strapiResponse.data) {\n  // æˆåŠŸï¼šæœ‰ data å±¬æ€§ï¼ˆStrapi v4 æ ¼å¼ï¼‰\n  isSuccess = true;\n} else if (strapiResponse && strapiResponse.error) {\n  // å¤±æ•—ï¼šæœ‰ error å±¬æ€§\n  isSuccess = false;\n  errorMessage = strapiResponse.error.message || JSON.stringify(strapiResponse.error);\n} else if (strapiResponse && (strapiResponse.id || strapiResponse.documentId)) {\n  // æˆåŠŸï¼šæœ‰ id æˆ– documentIdï¼ˆStrapi v4 ç›´æ¥å›æ‡‰æ ¼å¼ï¼‰\n  isSuccess = true;\n} else if (strapiResponse && strapiResponse.attributes) {\n  // æˆåŠŸï¼šæœ‰ attributesï¼ˆStrapi v4 å¦ä¸€ç¨®æ ¼å¼ï¼‰\n  isSuccess = true;\n} else {\n  // ç„¡æ³•åˆ¤æ–·ï¼Œæª¢æŸ¥å›æ‡‰å…§å®¹\n  const responseStr = JSON.stringify(strapiResponse);\n  if (!responseStr || responseStr === '{}' || responseStr === 'null') {\n    isSuccess = false;\n    errorMessage = 'Strapi æ²’æœ‰è¿”å›ä»»ä½•è³‡æ–™ï¼Œå¯èƒ½æ˜¯é€£æ¥å¤±æ•—æˆ–è«‹æ±‚æ ¼å¼éŒ¯èª¤';\n  } else if (responseStr.includes('error') || responseStr.includes('Error') || responseStr.includes('Unauthorized') || responseStr.includes('Forbidden')) {\n    isSuccess = false;\n    errorMessage = 'Strapi éŒ¯èª¤: ' + responseStr.substring(0, 300);\n  } else {\n    // é è¨­ç‚ºå¤±æ•—ï¼Œå› ç‚ºæ²’æœ‰æ˜ç¢ºçš„æˆåŠŸæ¨™è¨˜\n    isSuccess = false;\n    errorMessage = 'Strapi å›æ‡‰æ ¼å¼ç•°å¸¸ï¼š' + responseStr.substring(0, 300);\n  }\n}\n\nreturn {\n  json: {\n    ...$json,\n    SUCCESS: isSuccess,\n    STRAPI_RESPONSE: strapiResponse,\n    ARTICLE_TITLE: $json.GENERATED_TITLE,\n    ARTICLE_SLUG: $json.STRAPI_SLUG,\n    ERROR_MESSAGE: errorMessage\n  }\n};"
      },
      "id": "mark-success",
      "name": "Mark Success",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2850, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.STRAPI_URL || 'https://multi-site-strapi-backend-production.up.railway.app' }}/api/posts?filters[site][$eq]={{ $json.CURRENT_SITE }}&filters[category][$eq]={{ $json.CATEGORY }}&filters[date][$eq]={{ $json.DATE }}&sort=createdAt:desc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.STRAPI_TOKEN || '55f0580acab131abb8b2ddf799949b620a5ce912870030d61a46732f92e794512eda3634fe07397be92e6bc5399a444534269c0affd7b3eabd3a80136146406bf012eb491b17dcf8587af650e9b0a68f75d63cd733b748352df1da591f5c811c4e29ded4b64d9c016ab8f91dd623fc5c813b7705162b87fa29443d3a5e6b1993' }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-posts-for-export",
      "name": "Fetch Posts for Export",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3050, 300]
    },
    {
      "parameters": {
        "jsCode": "// æº–å‚™ HTML å…§å®¹ï¼ˆN8N Code ç¯€é»ä¸å…è¨±ä½¿ç”¨ fs æ¨¡çµ„ï¼Œå¯¦éš›æª”æ¡ˆå¯«å…¥éœ€è¦å¤–éƒ¨è™•ç†ï¼‰\nconst postsData = $input.item.json;\nconst posts = postsData.data || [];\nconst site = $json.CURRENT_SITE;\nconst category = $json.CATEGORY;\n\nconst htmlFiles = [];\n\nfor (const post of posts) {\n  const attrs = post.attributes || post;\n  const slug = attrs.slug;\n  const title = attrs.title || 'ç„¡æ¨™é¡Œ';\n  const htmlContent = attrs.html || '<p>ç„¡å…§å®¹</p>';\n  const date = attrs.date || new Date().toISOString().split('T')[0];\n  const excerpt = attrs.excerpt || '';\n  const imageUrl = attrs.imageUrl || '';\n\n  const fullHtml = `<!DOCTYPE html>\n<html lang=\"zh-TW\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>${title} | ${site}</title>\n    <meta name=\"description\" content=\"${excerpt}\">\n    <link rel=\"stylesheet\" href=\"${category === 'daily' ? '../' : ''}../css/style.css\">\n    <link rel=\"canonical\" href=\"https://multi-site-static-strapi-front.vercel.app/${site}/${category === 'daily' ? 'articles' : 'fixed-articles'}/${slug}.html\">\n</head>\n<body>\n    <main>\n        <article class=\"article-page\">\n            <div class=\"container\">\n                <div class=\"article-header\">\n                    <span class=\"article-date\">${date}</span>\n                    <h1>${title}</h1>\n                    ${imageUrl ? `<img src=\"${imageUrl}\" alt=\"${title}\" loading=\"lazy\">` : ''}\n                </div>\n                <div class=\"article-content\">\n                    ${htmlContent}\n                </div>\n            </div>\n        </article>\n    </main>\n    <script src=\"${category === 'daily' ? '../' : ''}../js/main.js\"></script>\n    <script src=\"${category === 'daily' ? '../' : ''}../../article-cms.js\" data-site=\"${site}\"></script>\n</body>\n</html>`;\n\n  htmlFiles.push({\n    slug: slug,\n    title: title,\n    html: fullHtml,\n    path: `${site}/${category === 'daily' ? 'articles' : 'fixed-articles'}/${slug}.html`\n  });\n}\n\nreturn {\n  json: {\n    ...$json,\n    HTML_FILES: htmlFiles,\n    EXPORT_SUCCESS: true\n  }\n};"
      },
      "id": "generate-html-files",
      "name": "Generate HTML Files",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3250, 300]
    },
    {
      "parameters": {
        "jsCode": "// æ¨™è¨˜ Git æ“ä½œéœ€è¦å¤–éƒ¨è™•ç†ï¼ˆN8N Code ç¯€é»ä¸å…è¨±ä½¿ç”¨ child_process æ¨¡çµ„ï¼‰\n// å¯¦éš›çš„ Git æ“ä½œéœ€è¦é€šéå¤–éƒ¨è…³æœ¬æˆ– API ä¾†å®Œæˆ\nconst htmlFiles = $json.HTML_FILES || [];\n\n// å³ä½¿æ²’æœ‰æª”æ¡ˆï¼Œä¹Ÿè¦–ç‚ºæˆåŠŸï¼ˆå› ç‚ºæ–‡ç« å·²ç¶“æˆåŠŸç”Ÿæˆä¸¦ä¿å­˜åˆ° Strapiï¼‰\nif (htmlFiles.length === 0) {\n  return {\n    json: {\n      ...$json,\n      GIT_SUCCESS: true,\n      GIT_NOTE: 'æ–‡ç« å·²æˆåŠŸç”Ÿæˆä¸¦ä¿å­˜åˆ° Strapiï¼Œä½†æ²’æœ‰æ‰¾åˆ°éœ€è¦åŒ¯å‡ºçš„æ–‡ç« ï¼ˆå¯èƒ½æŸ¥è©¢æ¢ä»¶ä¸åŒ¹é…æˆ–æ–‡ç« å°šæœªè¢«ç´¢å¼•ï¼‰',\n      HTML_FILES: []\n    }\n  };\n}\n\n// æº–å‚™ Git æ“ä½œè³‡è¨Š\nconst gitInfo = {\n  repoPath: $json.GITHUB_REPO_PATH,\n  repoUrl: $json.GITHUB_REPO_URL,\n  files: htmlFiles.map(f => f.path),\n  commitMessage: `Auto: åŒ¯å‡º ${htmlFiles.length} ç¯‡æ–‡ç«  (${$json.DATE})`\n};\n\nreturn {\n  json: {\n    ...$json,\n    GIT_INFO: gitInfo,\n    GIT_SUCCESS: true,\n    GIT_NOTE: 'Git æ“ä½œéœ€è¦å¤–éƒ¨è™•ç†ï¼ŒHTML å…§å®¹å·²æº–å‚™åœ¨ HTML_FILES ä¸­'\n  }\n};"
      },
      "id": "push-to-github",
      "name": "Push to GitHub",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3450, 300]
    },
    {
      "parameters": {
        "jsCode": "// æ”¶é›†æ‰€æœ‰çµæœ\nconst allResults = $input.all();\nconst successResults = allResults.filter(item => item.json.SUCCESS === true);\nconst failResults = allResults.filter(item => item.json.SUCCESS !== true);\n\n// ç”Ÿæˆçš„æ–‡ç« åˆ—è¡¨\nconst generatedArticles = successResults.map(item => ({\n  site: item.json.CURRENT_SITE,\n  title: item.json.ARTICLE_TITLE || null,\n  slug: item.json.ARTICLE_SLUG || null,\n  success: true\n}));\n\nconst summary = {\n  success: failResults.length === 0,\n  total: allResults.length,\n  successCount: successResults.length,\n  failCount: failResults.length,\n  generatedArticles: generatedArticles,\n  results: allResults.map(item => ({\n    site: item.json.CURRENT_SITE,\n    success: item.json.SUCCESS || false,\n    title: item.json.ARTICLE_TITLE || null,\n    slug: item.json.ARTICLE_SLUG || null,\n    error: item.json.ERROR_MESSAGE || item.json.EXPORT_ERROR || (item.json.GIT_ERROR && item.json.GIT_ERROR !== 'æ²’æœ‰æª”æ¡ˆéœ€è¦ä¸Šå‚³' ? item.json.GIT_ERROR : null) || null\n  }))\n};\n\nreturn {\n  json: summary\n};"
      },
      "id": "collect-results",
      "name": "Collect Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3650, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "webhook-response",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [3850, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Set Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Variables": {
      "main": [
        [
          {
            "node": "Process Parameters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Parameters": {
      "main": [
        [
          {
            "node": "Check Sites",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Sites": {
      "main": [
        [
          {
            "node": "Prepare Fetch All Sites",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Split Sites",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Fetch All Sites": {
      "main": [
        [
          {
            "node": "Fetch All Sites",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch All Sites": {
      "main": [
        [
          {
            "node": "Extract Sites",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Sites": {
      "main": [
        [
          {
            "node": "Split Sites",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Sites": {
      "main": [
        [
          {
            "node": "Fetch Existing Posts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Existing Posts": {
      "main": [
        [
          {
            "node": "Prepare Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Prompt": {
      "main": [
        [
          {
            "node": "Call Gemini API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Gemini API": {
      "main": [
        [
          {
            "node": "Parse Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Article": {
      "main": [
        [
          {
            "node": "Prepare Strapi Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Strapi Payload": {
      "main": [
        [
          {
            "node": "Save to Strapi",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Strapi": {
      "main": [
        [
          {
            "node": "Mark Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Success": {
      "main": [
        [
          {
            "node": "Fetch Posts for Export",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Posts for Export": {
      "main": [
        [
          {
            "node": "Generate HTML Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML Files": {
      "main": [
        [
          {
            "node": "Push to GitHub",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push to GitHub": {
      "main": [
        [
          {
            "node": "Collect Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collect Results": {
      "main": [
        [
          {
            "node": "Webhook Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-12-24T00:00:00.000Z",
  "versionId": "1"
}
